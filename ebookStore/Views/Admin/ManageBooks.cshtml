@model List<ebookStore.Models.Book>
<div class="container">
    <h1>Manage Books</h1>
    
    <!-- Search Bar -->
    <form method="get" action="@Url.Action("ManageBooks", "Admin")" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" name="searchQuery" placeholder="Search by title, author, or publisher" value="@Context.Request.Query["searchQuery"]" />
            <button class="btn btn-outline-secondary" type="submit">Search</button>
        </div>
    </form>


    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Cover</th> <!-- New column for cover -->
            <th>Title</th>
            <th>Author</th>
            <th>Publisher</th>
            <th>Current Buy Price</th>
            <th>Current Borrow Price</th>
            <th>Original Prices</th>
            <th>Discount Ends</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var book in Model)
        {
            <tr>
                <td>
                    @if (!string.IsNullOrEmpty(book.CoverImagePath))
                    {
                        <img src="@book.CoverImagePath" alt="Cover" style="max-width: 100px; max-height: 100px;" />
                    }
                    else
                    {
                        <span>No Cover</span> <!-- Fallback if no cover image -->
                    }
                </td>
                <td>@book.Title</td>
                <td>@book.AuthorName</td>
                <td>@book.Publisher</td>
                <td>
                    @if (book.Price?.IsDiscounted == true)
                    {
                        <span style="text-decoration: line-through; color: red;">
                            @book.Price.OriginalPriceBuy.ToString("C")
                        </span>
                    }
                    <span>@book.Price?.CurrentPriceBuy.ToString("C")</span>
                </td>
                <td>
                    @if (book.Price?.IsDiscounted == true)
                    {
                        <span style="text-decoration: line-through; color: red;">
                            @book.Price.OriginalPriceBorrow.ToString("C")
                        </span>
                    }
                    <span>@book.Price?.CurrentPriceBorrow.ToString("C")</span>
                </td>
                <td>
                    <span>Buy: @book.Price?.OriginalPriceBuy.ToString("C")</span><br />
                    <span>Borrow: @book.Price?.OriginalPriceBorrow.ToString("C")</span>
                </td>
                <td>@book.Price?.DiscountEndDate?.ToString("yyyy-MM-dd")</td>
                <td>
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setDiscountModal" data-id="@book.ID">
                        Set Discount
                    </a>
                    <a href="/Admin/EditBook/@book.ID" class="btn btn-warning">Edit</a>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<!-- Set Discount Modal -->
<div class="modal fade" id="setDiscountModal" tabindex="-1" aria-labelledby="setDiscountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setDiscountModalLabel">Set Discount</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="setDiscountForm" action="/Admin/SetDiscount">
                    <input type="hidden" id="bookId" name="bookId" />
                    <div class="mb-3">
                        <label for="discountedPriceBuy" class="form-label">Discounted Buy Price</label>
                        <input type="number" id="discountedPriceBuy" name="discountedPriceBuy" class="form-control" step="0.01" required />
                    </div>
                    <div class="mb-3">
                        <label for="discountedPriceBorrow" class="form-label">Discounted Borrow Price</label>
                        <input type="number" id="discountedPriceBorrow" name="discountedPriceBorrow" class="form-control" step="0.01" required />
                    </div>
                    <div class="mb-3">
                        <label for="discountEndDate" class="form-label">Discount End Date</label>
                        <input type="date" id="discountEndDate" name="discountEndDate" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Save Discount</button>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const setDiscountModal = document.getElementById("setDiscountModal");
        const bookIdInput = document.getElementById("bookId");

        setDiscountModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const bookId = button.getAttribute("data-id");
            bookIdInput.value = bookId;
        });

        document.getElementById("setDiscountForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const bookId = bookIdInput.value;
            const discountedPriceBuy = document.getElementById("discountedPriceBuy").value;
            const discountedPriceBorrow = document.getElementById("discountedPriceBorrow").value;
            const discountEndDate = document.getElementById("discountEndDate").value;

            try {
                const response = await fetch(`/Books/SetDiscount`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: bookId, discountedPriceBuy, discountedPriceBorrow, endDate: discountEndDate })
                });

                if (response.ok) {
                    location.reload(); // Reload the page to reflect changes
                } else {
                    alert("Failed to set discount. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });
    });
</script>
